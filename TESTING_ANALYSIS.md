# Отчет об анализе тестируемости проекта nexus-util

## 1. Анализ тестируемости

### Функции готовые к тестированию (в текущем виде)

1. **config пакет:**
   - `DefaultConfigPath()` - простая функция, легко тестируется
   - `Config.Validate()` - валидация, легко тестируется
   - `Config.GetNexusAddress()`, `GetUser()`, `GetPassword()` - геттеры, легко тестируются
   - `SaveConfig()` - частично тестируема (зависит от файловой системы, но можно использовать temp dir)

2. **nexus пакет:**
   - `NewNexusClient()` - конструктор, легко тестируется (уже есть тесты)
   - `Logf()` - простой метод логирования, легко тестируется

### Проблемные участки кода

#### 1. nexus.NexusClient - все методы работы с API
**Проблемы:**
- Прямая зависимость от `http.Client` - невозможно мокировать HTTP запросы
- Прямые обращения к файловой системе (`os.Open`, `os.Create`, `os.Stat`, `os.MkdirAll`, `filepath.Walk`)
- Нет интерфейса для NexusClient - невозможно создать моки для команд
- Методы делают реальные HTTP запросы - требуют реального сервера для тестирования

**Затронутые методы:**
- `GetFilesInDirectory()` - HTTP запросы + JSON парсинг
- `DeleteFile()`, `DeleteDirectory()` - HTTP запросы
- `DownloadFile()`, `DownloadFileWithPath()` - HTTP запросы + файловая система
- `UploadFile()`, `UploadDirectory()` - HTTP запросы + файловая система
- `ListRepositories()` - HTTP запросы + JSON парсинг
- `FileExists()`, `GetFileSize()` - HTTP запросы
- `DownloadToBuffer()`, `UploadFromBuffer()` - HTTP запросы
- `TransferFile()` - комбинация методов

#### 2. cmd/asset/* - все команды
**Проблемы:**
- Прямая зависимость от `nexus.NewNexusClient()` - невозможно мокировать
- Прямые обращения к файловой системе (`os.Stat`)
- Плотная связь с Cobra командами - сложно тестировать изолированно
- Зависимость от `config.LoadConfigWithFlags()` - требует реальных файлов конфигурации

**Затронутые функции:**
- `runList()`, `runPush()`, `runPull()`, `runDelete()` - все команды asset

#### 3. cmd/init/init.go
**Проблемы:**
- `readPassword()` - зависимость от stdin, сложно тестировать
- Прямая зависимость от `config.SaveConfig()` - требует файловой системы

#### 4. cmd/repo/repo.go
**Проблемы:**
- Прямая зависимость от `nexus.NewNexusClient()`
- Зависимость от `config.LoadConfigWithFlags()`

#### 5. cmd/sync/sync.go
**Проблемы:**
- Прямая зависимость от `nexus.NewNexusClient()` (два клиента)
- Сложная логика с множественными зависимостями
- Прямые обращения к `fmt.Printf` для вывода

#### 6. config.LoadConfig()
**Проблемы:**
- Зависимость от глобального состояния viper - может вызывать проблемы при параллельных тестах
- Зависимость от файловой системы (хотя можно использовать temp dir)

## 2. План рефакторинга

### Шаг 1: Создание интерфейсов для зависимостей

1. **HTTPClient интерфейс** - для абстракции HTTP запросов
2. **FileSystem интерфейс** - для абстракции файловой системы
3. **NexusClient интерфейс** - для возможности мокирования в командах

### Шаг 2: Рефакторинг nexus.NexusClient

- Внедрение зависимостей через конструктор
- Разделение логики и побочных эффектов
- Использование интерфейсов вместо конкретных типов

### Шаг 3: Рефакторинг команд

- Принятие интерфейса NexusClient вместо создания конкретного экземпляра
- Извлечение бизнес-логики из Cobra handlers

### Шаг 4: Улучшение config пакета

- Устранение зависимости от глобального viper состояния
- Создание интерфейса для конфигурации

## 3. Стратегия тестирования

- Использование table-driven tests для параметризованных тестов
- Создание моков для всех интерфейсов
- Покрытие happy path, edge cases, и error cases
- Использование testify/assert для читаемых проверок
- Стремление к покрытию минимум 80%

